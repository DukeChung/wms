@using NBK.WMS.Portal.Helpers

@{
    ViewBag.Title = "创建商品外借单";
}

@Html.Breadcrumb("商品外借", "/SkuBorrow/SkuBorrowMaintain", "创建商品外借单")


<div class="wrapper wrapper-content animated fadeInRight ecommerce">
    <div id="SkuBorrowView" class="ibox-content m-b-sm border-bottom">

        <div class="row">
            <label class="col-sm-2 control-label ">
                商品外借单信息
            </label>
        </div>
        <div class="form-group hr-line-dashed"></div>


        <div class="row">
            @*<div class="col-sm-3">
                    @Html.DataPickerTextBox("借出时间", "BorrowStartTime")
                </div>
                <div class="col-sm-3">
                    @Html.DataPickerTextBox("归还时间", "BorrowEndTime")
                </div>*@
            <div class="col-sm-3">
                <label class="control-label" for="BorrowName">外借人</label>
                <input type="text" id="BorrowName" name="BorrowName" class="form-control">
            </div>
            <div class="col-sm-3">
                <label class="control-label" for="LendingDepartment">外借部门</label>
                <input type="text" id="LendingDepartment" name="LendingDepartment" class="form-control">
            </div>
            <div class="col-sm-6">
                <label class="control-label" for="Remark">备注</label>
                <input type="text" id="Remark" name="Remark" class="form-control">
            </div>
        </div>

        <div class="row" style="margin-top:30px">
            <label class="col-sm-2 control-label ">
                选择商品
            </label>
        </div>
        <div class="form-group hr-line-dashed"></div>

        <div class="row">
            <div class="col-sm-3">
                @Html.SearchTextBox("商品条码", "UPC")
            </div>
            <div class="col-sm-3">
                @Html.SearchTextBox("商品编号", "SkuCode")
            </div>
            <div class="col-sm-3">
                @Html.SearchTextBox("商品名称", "SkuName")
            </div>
            <div class="col-sm-3">
                <div class="form-group">
                    <label class="control-label">仓库:</label>
                    <select id="WarehouseSysId" name="WarehouseSysId" class="form-control" disabled="disabled">
                        @{
                            foreach (var warehouse in (List<SelectListItem>)ViewBag.WarehouseList)
                            {
                                if (ViewBag.WarehouseSysId.ToString() == warehouse.Value)
                                {
                                    <option value="@warehouse.Value" selected="selected">@warehouse.Text</option>
                                }
                                else
                                {
                                    <option value="@warehouse.Value">@warehouse.Text</option>
                                }
                            }
                        }
                    </select>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-3">
                @Html.SearchTextBox("货位", "Loc")
            </div>
            <div class="col-sm-3">
                @Html.SearchTextBox("批次", "Lot")
            </div>
            <div class="col-sm-3">
                @Html.SearchTextBox("托盘", "Lpn")
            </div>
            <div class="col-sm-3">
                <button id="btnSearch" class="btn btn-primary" type="button" style="margin-top:25px;float: left; ">查询</button>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <div class="ibox">
                    <div class="ibox-content">
                        <table id="gvSkuBorrowSku" class="table table-striped table-bordered table-hover dataTables-example">
                            <thead>
                                <tr>
                                    <th width="5%"><input type="checkbox" id="ckbAll" onclick="AddSkuBorrowModel.gvSkuBorrowSkuCheckAll(this);" /></th>
                                    <th data-data="SkuCode">商品编号</th>
                                    <th data-data="SkuName">商品名称</th>
                                    <th data-data="SkuDescr">商品描述</th>
                                    <th data-data="UPC">商品条码</th>
                                    <th data-data="WareHouseName">仓库</th>
                                    <th data-data="DisplayQty">库存</th>
                                    <th data-data="Loc">货位</th>
                                    <th data-data="Lot">批次</th>
                                    <th data-data="Lpn">托盘</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <label class="col-sm-2 control-label ">
                商品外借清单
            </label>
        </div>
        <form id="packForm" class="form-horizontal">

            <div class="row">
                <div class="col-lg-12">
                    <div class="ibox">
                        <div class="ibox-content">

                            <table id="skuBorrowDetails" class="table table-striped table-bordered table-hover dataTables-example">
                                <thead>
                                    <tr>
                                        <th width="5%"><input type="checkbox" id="ckbAll" onclick="AddSkuBorrowModel.gvajustmentDetailsCheckAll(this);" /></th>
                                        <th data-data="SkuCode">商品编号</th>
                                        <th data-data="SkuName">商品名称</th>
                                        <th data-data="SkuDescr">商品描述</th>
                                        <th data-data="UPC">商品条码</th>
                                        <th data-data="UOMCode">单位</th>
                                        <th data-data="WareHouseName">仓库</th>
                                        <th data-data="Loc">货位</th>
                                        <th data-data="Lot">批次</th>
                                        <th data-data="Lpn">托盘</th>
                                        <th data-data="BorrowStartTime">借出时间</th>
                                        <th data-data="BorrowEndTime">归还时间</th>
                                        <th data-data="IsDamage">是否损坏</th>
                                        <th data-data="DisplayQty">借出数量</th>
                                        <th data-data="Remark">备注</th>
                                        <th>图片</th>
                                    </tr>
                                </thead>

                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ibox-footer text-right tooltip-demo">
                <a class="btn btn-sm btn-primary" id="btnAdd"><i class="fa fa-check-square-o"></i> 保存</a>
                <a class="btn btn-white btn-sm" id="btnReturn"><i class="fa fa-times"></i> 返回</a>
            </div>
        </form>
    </div>
</div>

@section Styles {
    @Styles.Render("~/Content/plugins/dataTables/dataTablesStyles")
    @Styles.Render("~/plugins/dataPickerStyles")
    @Styles.Render("~/plugins/jasnyBootstrapStyles")
}

@section Scripts {
    @Scripts.Render("~/plugins/dataTables")
    @Scripts.Render("~/plugins/dataPicker")

    <script src="~/Scripts/Utility/Common.js"></script>

    <script>
        var AddSkuBorrowModel = {
            skutable: {},
            skuBorrowDetailsTable: {},
            skuBorrowDetailsSource: {},

            init: function () {
                var _self = this;



                _self.skutable = $('#gvSkuBorrowSku').DataTable({
                    "sAjaxSource": "GetSkuList",
                    "fnServerParams": function (aoData) { //查询条件
                        aoData.push(
                            { "name": "UPC", "value": $("#UPC").val() },
                            { "name": "SkuCode", "value": $("#SkuCode").val() },
                            { "name": "SkuName", "value": $("#SkuName").val() },
                            { "name": "WarehouseSysId", "value": $("#WarehouseSysId").val() },
                            { "name": "Loc", "value": $("#Loc").val() },
                            { "name": "Lot", "value": $("#Lot").val() },
                            { "name": "Lpn", "value": $("#Lpn").val() }
                        );
                    },
                    dom: 'Bfrtip',
                    buttons: [
                        {
                            text: '添加',
                            action: function (e, dt, node, config) {
                                var sysIdList = GetGridMultiselectSysId();
                                if (sysIdList != null) {
                                    var arr = AddSkuBorrowModel.skutable.rows(':has(:checkbox:checked)');
                                    var skuBorrowDetails = AddSkuBorrowModel.getSkuBorrowDetailSource();

                                    $.each(arr.data(), function (i) {
                                        var selectSku = this;
                                        var isAdd = false;
                                        if (skuBorrowDetails.length > 0) {
                                            for (var i = 0; i < skuBorrowDetails.length ; i++) {
                                                if (skuBorrowDetails[i].SkuSysId == selectSku.SkuSysId
                                                    && skuBorrowDetails[i].Loc == selectSku.Loc
                                                    && skuBorrowDetails[i].Lot == selectSku.Lot) {
                                                    //msgErro("已添加过商品 '" + selectSku.SkuName + "',请勿重复添加!");
                                                    isAdd = true;
                                                    break;
                                                }
                                            }
                                        }

                                        if (!isAdd) {
                                            AddSkuBorrowModel.skuBorrowDetailsTable.rows.add([{
                                                "SkuSysId": selectSku.SkuSysId,
                                                "SkuCode": selectSku.SkuCode,
                                                "SkuName": selectSku.SkuName,
                                                "SkuDescr": selectSku.SkuDescr,
                                                "UPC": selectSku.UPC,
                                                "UOMCode": selectSku.UOMCode,
                                                "WareHouseName": selectSku.WareHouseName,
                                                "Loc": selectSku.Loc,
                                                "Lot": selectSku.Lot,
                                                "Lpn": selectSku.Lpn,

                                                "DisplayQty": 1,
                                                "Remark": "",
                                                "WareHouseSysId": selectSku.WareHouseSysId,
                                            }]).draw();
                                        }
                                    });

                                    $("input[name='BorrowStartTime']").each(function () {
                                        $(this).datepicker({
                                            todayBtn: "linked",
                                            keyboardNavigation: false,
                                            forceParse: false,
                                            calendarWeeks: true,
                                            autoclose: true
                                        });
                                    })


                                    $("input[name='BorrowEndTime']").each(function () {
                                        $(this).datepicker({
                                            todayBtn: "linked",
                                            keyboardNavigation: false,
                                            forceParse: false,
                                            calendarWeeks: true,
                                            autoclose: true
                                        });
                                    })

                                    msgAlert("添加完成！(注:已添加商品不会被重复添加)");
                                }
                            },
                        }
                    ],
                    "columnDefs": [
                        {
                            "targets": 0,
                            "width": "15px",
                            render: function (data, type, full, meta) {
                                return '<input type="checkbox" id="checkbox-all-' + full.SysId + '" value="' + full.SysId + '" />';
                            }
                        }
                    ],
                    "bServerSide": true,
                    "bProcessing": true,
                    "bPaginate": true, //翻页功能
                    "bLengthChange": true, //改变每页显示数据数量
                    "bFilter": false, //过滤功能
                    "bSort": false, //排序功能
                    "bInfo": true, //页脚信息
                    "bAutoWidth": true, //自动宽度
                    "aaSorting": [[2, "Asc"]],
                    "oLanguage": {
                        "sLengthMenu": "每页显示 _MENU_ 条记录",
                        "sInfo": "从 _START_ 到 _END_ /共 _TOTAL_ 条数据",
                        "sInfoEmpty": "",
                        "sInfoFiltered": "(从 _MAX_ 条数据中检索)",
                        "oPaginate": {
                            "sFirst": "首页",
                            "sPrevious": "前一页",
                            "sNext": "后一页",
                            "sLast": "尾页"
                        },
                        "sZeroRecords": "没有检索到数据"
                    }
                });

                _self.skuBorrowDetailsTable = $('#skuBorrowDetails').DataTable({
                    data: _self.skuBorrowDetailsSource,
                    dom: 'Bfrtip',
                    buttons: [
                        {
                            text: '删除',
                            action: function (e, dt, node, config) {
                                AddSkuBorrowModel.skuBorrowDetailsTable
                                    .rows(':has(:checkbox:checked)')
                                    .remove()
                                    .draw();
                            },
                        }
                    ],
                    "columnDefs": [
                        {
                            "targets": 0,
                            "width": "15px",
                            render: function (data, type, full, meta) {
                                return '<input type="checkbox" id="checkbox-all-' + full.SysId + '" value="' + full.SysId + '" />';
                            }
                        },
                        {
                            "targets": 10,
                            render: function (data, type, full, meta) {
                                return '<div style="width:150px"><div class="input-group date"><span class="input-group-addon"> <i class="fa fa-calendar"></i></span>  <input type="text" class="form-control"  name="BorrowStartTime" value="" onchange="AddSkuBorrowModel.startTimeChange(this)"/></div></div>';
                            }
                        },
                        {
                            "targets": 11,
                            render: function (data, type, full, meta) {
                                return '<div style="width:150px"><div class="input-group date"><span class="input-group-addon"> <i class="fa fa-calendar"></i></span>  <input type="text" class="form-control"  name="BorrowEndTime" value="" onchange="AddSkuBorrowModel.endTimeChange(this)"/></div></div>';
                            }
                        },

                        {
                            "targets": 12,
                            render: function (data, type, full, meta) {
                                var selection = '<select class="form-control" style="width:60px;" onchange="AddSkuBorrowModel.skuBorrowIsDamageChange(this)">';
                                selection += '<option value=0>否</option>';
                                selection += '<option value=1>是</option>';
                                selection += '</select>';
                                return selection;
                            }
                        },

                        {
                            "targets": 13,
                            render: function (data, type, full, meta) {
                                return '<input class="form-control"  type="number" style="width:80px;" value="1" onblur="AddSkuBorrowModel.qtyBlur(this)" min="1"/>';
                            }
                        },
                        {
                            "targets": 14,
                            render: function (data, type, full, meta) {
                                return '<input class="form-control" style="width:60px;" value="" onblur="AddSkuBorrowModel.remarkBlur(this)" />';
                            }
                        },
                        {
                            "targets": 15,
                            "width": "20%",
                            render: function (data, type, full, meta) {
                                return '<div class="fileinput fileinput-new" data-provides="fileinput"><span class="btn btn-default btn-file"><span class="fileinput-new">选择图片</span><input type="file" id="file_' + full.SkuSysId + full.Lot + full.Loc + full.Lpn + '" onchange="UploadImage(this);"></span><div class="pictures"></div></div>';
                            }
                        }
                    ],
                    "bServerSide": false,
                    "bProcessing": true,
                    "bPaginate": false, //翻页功能
                    "bLengthChange": true, //改变每页显示数据数量
                    "bFilter": false, //过滤功能
                    "bSort": false, //排序功能
                    "bInfo": true, //页脚信息
                    "bAutoWidth": true, //自动宽度
                    "oLanguage": {
                        "sLengthMenu": "每页显示 _MENU_ 条记录",
                        "sInfo": "从 _START_ 到 _END_ /共 _TOTAL_ 条数据",
                        "sInfoEmpty": "",
                        "sInfoFiltered": "(从 _MAX_ 条数据中检索)",
                        "oPaginate": {
                            "sFirst": "首页",
                            "sPrevious": "前一页",
                            "sNext": "后一页",
                            "sLast": "尾页"
                        },
                        "sZeroRecords": "没有检索到数据"
                    }
                });

                $("#btnSearch").bind("click", function () { //按钮 触发table重新请求服务器
                    AddSkuBorrowModel.skutable.ajax.reload();
                });

                var flag = false;
                $("#btnAdd").bind("click", function () {
                    if (flag) {
                        return;
                    }
                    flag = true;
                    var skuBorrowDetaildata = AddSkuBorrowModel.skuBorrowDetailsTable.data();
                    if (skuBorrowDetaildata.length == 0) {
                        msgAlert("请至少选择一个商品");
                        flag = false;
                        return;
                    }
                    //if ($("#BorrowStartTime").val() > $("#BorrowEndTime").val()) {
                    //    msgAlert("外借单归还时间必须大于等于借出时间");
                    //    flag = false;
                    //    return;
                    //}

                    //if (($("#BorrowStartTime").val() == "" || $("#BorrowStartTime").val() == null) && ($("#BorrowEndTime").val() != "")) {
                    //    msgAlert("外借单必须填写借出时间");
                    //    flag = false;
                    //    return;
                    //}

                    var skuBorrowDetailList = AddSkuBorrowModel.getSkuBorrowDetailSource();
                    var qtyValidate = "";
                    var timeValidate = "";
                    var fillValidate = "";
                    for (var i = 0; i < skuBorrowDetailList.length; i++) {
                        var row = i + 1;
                        if (!isPositive(skuBorrowDetailList[i]["DisplayQty"])) {
                            qtyValidate = qtyValidate + row + ",";
                        }
                        if ((skuBorrowDetailList[i]["BorrowStartTime"] == "" || skuBorrowDetailList[i]["BorrowStartTime"] == null) && (skuBorrowDetailList[i]["BorrowEndTime"] != null && skuBorrowDetailList[i]["BorrowEndTime"] != "")) {
                            fillValidate = fillValidate + row + ",";
                        }
                        if (Date.parse(skuBorrowDetailList[i]["BorrowStartTime"]) > Date.parse(skuBorrowDetailList[i]["BorrowEndTime"])) {
                            timeValidate = timeValidate + row + ",";
                        }
                    }
                    if (qtyValidate != "" || fillValidate != "" || timeValidate != "") {
                        var alertMsg = "";
                        if (qtyValidate != "") {
                            qtyValidate = qtyValidate.substring(0, qtyValidate.length - 1);
                            alertMsg = "第" + qtyValidate + "行商品必须借出数量必须大于0\n";
                        }
                        if (fillValidate != "") {
                            fillValidate = fillValidate.substring(0, fillValidate.length - 1);
                            alertMsg = "第" + fillValidate + "行商品必须填写借出时间\n";
                        }
                        if (timeValidate != "") {
                            timeValidate = timeValidate.substring(0, timeValidate.length - 1);
                            alertMsg = alertMsg + "第" + timeValidate + "行商品归还时间必须大于等于借出时间";
                        }
                        if (alertMsg != "") {
                            msgAlert(alertMsg);
                        }
                        flag = false;
                        return;
                    }



                    var requestData = {
                        WareHouseSysId: $("#WarehouseSysId").val(),
                        Status: "10",
                        //BorrowStartTime: $("#BorrowStartTime").val(),
                        //BorrowEndTime: $("#BorrowEndTime").val(),
                        BorrowName: $("#BorrowName").val(),
                        LendingDepartment: $("#LendingDepartment").val(),
                        Remark: $("#Remark").val(),
                        SkuBorrowDetailList: skuBorrowDetailList
                    };

                    $.ajax({
                        url: "@Url.Action("AddSkuBorrowService", "SkuBorrow")",
                        data: requestData,
                        dataType: "json",
                        type: "post",
                        success: function (data) {
                            flag = false;
                            if (data.success) {
                                msgSuccess("保存成功!");
                                AddSkuBorrowModel.backParentPage();
                            }
                            else {
                                msgErro(data.message);
                            }
                        },
                        error: function () {
                            flag = false;
                            msgErro("操作失败！");
                        }
                    });

                });

                $("#btnReturn").bind("click", function () {
                    AddSkuBorrowModel.backParentPage();
                });
            },

            startTimeChange: function (obj) {
                var selectIndex = $(obj).parent().parent().parent().parent().index();

                AddSkuBorrowModel.skuBorrowDetailsTable.data()[selectIndex]["BorrowStartTime"] = $(obj).val();
            },

            endTimeChange: function (obj) {
                var selectIndex = $(obj).parent().parent().parent().parent().index();

                AddSkuBorrowModel.skuBorrowDetailsTable.data()[selectIndex]["BorrowEndTime"] = $(obj).val();
            },

            qtyBlur: function (obj) {
                var selectIndex = $(obj).parent().parent().index();

                AddSkuBorrowModel.skuBorrowDetailsTable.data()[selectIndex]["DisplayQty"] = $(obj).val();
            },
            skuBorrowIsDamageChange: function (obj) {
                var selectIndex = $(obj).parent().parent().index();

                AddSkuBorrowModel.skuBorrowDetailsTable.data()[selectIndex]["IsDamage"] = $(obj).val();
            },
            remarkBlur: function (obj) {
                var selectIndex = $(obj).parent().parent().index();

                AddSkuBorrowModel.skuBorrowDetailsTable.data()[selectIndex]["Remark"] = $(obj).val();
            },
            gvSkuBorrowSkuCheckAll: function (obj) {
                $("#gvSkuBorrowSku tbody input[type='checkbox']").each(function () {
                    this.checked = obj.checked;
                });
            },
            gvajustmentDetailsCheckAll: function (obj) {
                $("#skuBorrowDetails tbody input[type='checkbox']").each(function () {
                    this.checked = obj.checked;
                });
            },
            getSkuBorrowDetailSource: function () {
                var skuBorrowDetailList = [];
                var skuBorrowDetaildata = AddSkuBorrowModel.skuBorrowDetailsTable.data();

                for (var i = 0; i < skuBorrowDetaildata.length; i++) {
                    var pictures = [];
                    $("#file_" + skuBorrowDetaildata[i].SkuSysId + skuBorrowDetaildata[i].Lot + skuBorrowDetaildata[i].Loc + skuBorrowDetaildata[i].Lpn).parent().parent().children(".pictures").children(".fileinput-filename").each(function () {
                        var picture = {
                            Name: $(this).attr("Name"),
                            Url: $(this).attr("Url"),
                            Size: $(this).attr("Size"),
                            Suffix: $(this).attr("Suffix")
                        };
                        pictures.push(picture);
                    });
                    skuBorrowDetaildata[i].PictureDtoList = pictures;
                    skuBorrowDetailList.push(skuBorrowDetaildata[i]);
                }

                return skuBorrowDetailList;
            },
            backParentPage: function () {
                window.location.href = '@Url.Action("SkuBorrowMaintain", "SkuBorrow")'
            }
        }

        $(function () {
            AddSkuBorrowModel.init();

            $('#divBorrowStartTime .input-group.date').datepicker({
                todayBtn: "linked",
                keyboardNavigation: false,
                forceParse: false,
                calendarWeeks: true,
                autoclose: true
            });

            $('#divBorrowEndTime .input-group.date').datepicker({
                todayBtn: "linked",
                keyboardNavigation: false,
                forceParse: false,
                calendarWeeks: true,
                autoclose: true
            });

        })

        function UploadImage(obj) {
            var _this = $(obj);
            var pictures = $(obj).parent().parent().children(".pictures");
            if (pictures.children(".fileinput-filename").length >= 3) {
                msgErro("最多上传3张图片！");
                return false;
            }
            saveLoading('show');
            var formData = new FormData();
            formData.append("file", $(obj)[0].files[0]);
            $.ajax({
                url: "@Url.Action("UploadImage", "SkuBorrow")",
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (data) {
                    saveLoading('hide');
                    _this.val('');
                    if (data.Success) {
                        msgSuccess("上传成功！");
                        pictures.append('<span style="margin-left:5px;max-width:100px" title="' + data.Name + '" class="fileinput-filename" Name="' + data.Name + '" Url="' + data.Url + '" Size="' + data.Size + '" Suffix="' + data.Suffix + '"><a href="' + data.ShowUrl + '"  target="_blank">' + data.Name + '</a></span><a class="close" data-dismiss="fileinput" style="float: none" onclick="RemovePiciture(this);">&times;</a>');
                    }
                    else {
                        msgErro(data.Message);
                    }
                },
                error: function (data) {
                    _this.val('');
                    saveLoading('hide');
                    msgErro("上传失败！");
                }
            });
        }

        function RemovePiciture(obj) {
            $(obj).prev().remove();
            $(obj).remove();
        }

        function isPositive(x) {
            let num = parseFloat(x);
            return (!isNaN(num)) && (isFinite(num)) && (num > 0);
        }

    </script>
}
